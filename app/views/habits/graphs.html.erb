<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="container-fluid mt-4 px-4">
  <div class="row justify-content-center">
    <div class="col-md-12 col-xl-10">
      <div class="card shadow-lg border-2" style="border-color: #007bff;">
        <div class="card-header bg-primary text-white text-center py-4">
          <h1 class="card-title mb-2" style="font-size: 2rem;">ğŸ“Š ç¿’æ…£é”æˆã‚°ãƒ©ãƒ•</h1>
          <p class="mb-0" style="font-size: 1.1rem;">ã‚ãªãŸã®ç¿’æ…£é”æˆçŠ¶æ³ã‚’å¯è¦–åŒ–</p>
        </div>
        <div class="card-body p-5">

          <div class="d-flex justify-content-center gap-3 mb-5">
            <%= link_to "ç¿’æ…£ä¸€è¦§ã«æˆ»ã‚‹", habits_path,
                class: "btn btn-primary btn-lg px-4",
                style: "font-size: 1.1rem; padding: 0.8rem 2rem;" %>
            <%= link_to "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹", dashboard_path,
                class: "btn btn-primary btn-lg px-4",
                style: "font-size: 1.1rem; padding: 0.8rem 2rem;" %>
          </div>

          <% if @habits.any? %>
            <%
              # Prepare date range for X-axis labels
              date_labels = @date_range.map { |date| date.strftime('%-m/%-d') }

              # Calculate daily achievement rate (calculated on server side for accuracy)
              daily_completion_data = @date_range.map do |date|
                total_habits = @habits.count
                completed_habits = @habits.count { |habit|
                  habit.habit_records.exists?(recorded_at: date, completed: true)
                }
                total_habits.zero? ? 0 : (completed_habits.to_f / total_habits * 100).round(1)
              end

              # Daily chart configuration
              daily_chart_data = {
                labels: date_labels,
                datasets: [{
                  label: 'é”æˆç‡ (%)',
                  data: daily_completion_data,
                  borderColor: 'rgb(75, 192, 192)',
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  tension: 0.3,
                  fill: true
                }]
              }

              daily_chart_options = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: {
                    display: true,
                    position: 'top',
                  },
                  title: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: ->(context) { "é”æˆç‡: #{context.parsed.y}%" }
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                      callback: ->(value) { "#{value}%" }
                    }
                  }
                }
              }

              # Habit chart configuration with completed days info
              habit_chart_data = {
                labels: @habit_data.map { |h| h[:title] },
                datasets: [{
                  label: 'é”æˆç‡ (%)',
                  data: @habit_data.map { |h| h[:achievement_rate] },
                  completedDays: @habit_data.map { |h| h[:completed_days] },
                  backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)',
                    'rgba(255, 159, 64, 0.7)',
                    'rgba(199, 199, 199, 0.7)',
                    'rgba(83, 102, 255, 0.7)',
                    'rgba(255, 99, 255, 0.7)',
                    'rgba(99, 255, 132, 0.7)'
                  ],
                  borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(199, 199, 199, 1)',
                    'rgba(83, 102, 255, 1)',
                    'rgba(255, 99, 255, 1)',
                    'rgba(99, 255, 132, 1)'
                  ],
                  borderWidth: 2
                }]
              }

              habit_chart_options = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: {
                    display: true,
                    position: 'top',
                  },
                  title: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                      callback: ->(value) { "#{value}%" }
                    }
                  }
                }
              }
            %>

            <!-- Daily Achievement Rate Line Chart -->
            <div class="card mb-5 shadow-sm">
              <div class="card-header bg-light">
                <h3 class="card-title mb-0" style="font-size: 1.5rem;">ğŸ“ˆ æ—¥åˆ¥é”æˆç‡ï¼ˆç›´è¿‘30æ—¥é–“ï¼‰</h3>
              </div>
              <div class="card-body">
                <canvas id="daily-chart" style="max-height: 400px;"></canvas>
              </div>
            </div>

            <!-- Habit Achievement Rate Bar Chart -->
            <div class="card shadow-sm">
              <div class="card-header bg-light">
                <h3 class="card-title mb-0" style="font-size: 1.5rem;">ğŸ“Š ç¿’æ…£åˆ¥é”æˆç‡ï¼ˆç›´è¿‘30æ—¥é–“ï¼‰</h3>
              </div>
              <div class="card-body">
                <canvas id="habit-chart" style="max-height: 400px;"></canvas>
              </div>
            </div>
            
          <% else %>
            <div class="text-center py-5">
              <div class="mb-4" style="font-size: 3rem;">ğŸ“</div>
              <h3 class="text-primary mb-3" style="font-size: 1.5rem; font-weight: 600;">
                ã¾ã ç¿’æ…£ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
              </h3>
              <p class="text-muted mb-4" style="font-size: 1.1rem; line-height: 1.6;">
                æ–°ã—ã„ç¿’æ…£ã‚’ä½œæˆã—ã¦ã€ã‚°ãƒ©ãƒ•ã§é”æˆçŠ¶æ³ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼
              </p>
              <%= link_to "æœ€åˆã®ç¿’æ…£ã‚’ä½œæˆ", new_habit_path,
                  class: "btn btn-primary btn-lg px-5",
                  style: "font-size: 1.2rem; padding: 1rem 2.5rem; border-radius: 0.7rem;" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<% if @habits.any? %>
<script>
// Chart initialization flag to prevent multiple initializations
let chartsInitialized = false;
let dailyChart = null;
let habitChart = null;

function initializeCharts() {
  // Prevent multiple initializations
  if (chartsInitialized) {
    console.log('Charts already initialized, skipping...');
    return;
  }

  const dailyCanvas = document.getElementById('daily-chart');
  const habitCanvas = document.getElementById('habit-chart');

  if (!dailyCanvas || !habitCanvas) {
    console.error('Chart canvases not found');
    return;
  }

  console.log('Initializing charts...');

  // Chart data from server
  const dailyChartData = <%= raw daily_chart_data.to_json %>;
  const dailyChartOptions = <%= raw daily_chart_options.to_json %>;
  const habitChartData = <%= raw habit_chart_data.to_json %>;
  const habitChartOptions = <%= raw habit_chart_options.to_json %>;

  // Add tooltip callbacks for daily chart
  dailyChartOptions.plugins = dailyChartOptions.plugins || {};
  dailyChartOptions.plugins.tooltip = dailyChartOptions.plugins.tooltip || {};
  dailyChartOptions.plugins.tooltip.callbacks = {
    label: function(context) {
      return 'é”æˆç‡: ' + context.parsed.y + '%';
    }
  };

  // Add tooltip callbacks for habit chart with completed days
  const completedDays = habitChartData.datasets[0].completedDays;
  habitChartOptions.plugins = habitChartOptions.plugins || {};
  habitChartOptions.plugins.tooltip = habitChartOptions.plugins.tooltip || {};
  habitChartOptions.plugins.tooltip.callbacks = {
    label: function(context) {
      const value = context.parsed.y;
      const days = completedDays[context.dataIndex];
      return [
        'é”æˆç‡: ' + value + '%',
        'å®Œäº†æ—¥æ•°: ' + days + '/30æ—¥'
      ];
    }
  };

  // Create daily achievement rate line chart
  dailyChart = new Chart(dailyCanvas, {
    type: 'line',
    data: dailyChartData,
    options: dailyChartOptions
  });

  // Create habit achievement rate bar chart
  habitChart = new Chart(habitCanvas, {
    type: 'bar',
    data: habitChartData,
    options: habitChartOptions
  });

  chartsInitialized = true;
  console.log('Charts initialized successfully');
}

function destroyCharts() {
  if (dailyChart) {
    dailyChart.destroy();
    dailyChart = null;
  }
  if (habitChart) {
    habitChart.destroy();
    habitChart = null;
  }
  chartsInitialized = false;
  console.log('Charts destroyed');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initializeCharts);

// Handle Turbo navigation
document.addEventListener('turbo:load', function() {
  destroyCharts();
  initializeCharts();
});

document.addEventListener('turbo:before-visit', destroyCharts);
</script>
<% end %>
